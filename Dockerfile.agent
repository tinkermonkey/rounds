# ============================================================================
# Dockerfile.agent for rounds
# ============================================================================
# An autonomous diagnostic agent for OpenTelemetry data analysis
# Python 3.11+ daemon using Claude Code CLI for LLM-powered diagnosis
# ============================================================================

# ============================================================================
# Stage 1: Base Environment Setup
# ============================================================================
FROM clauditoreum-orchestrator:latest

# The base image already includes:
# - Claude CLI (REQUIRED - must be present)
# - Git CLI (REQUIRED - must be present)
# - GitHub CLI (REQUIRED - must be present)
# - Python 3.11
# - Essential build tools
# - procps package (provides 'ps' command needed by Claude CLI)

USER root

# ============================================================================
# Stage 2: Install Project-Specific Dependencies
# ============================================================================
# Install additional system dependencies for the rounds project
# - sqlite3: For the signature database operations
# - curl: For health checks and API testing
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        sqlite3 \
        curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# Stage 3: Pre-install Python Dependencies (when requirements.txt exists)
# ============================================================================
# The rounds project will need these core Python packages:
# - httpx or requests: For SigNoz API polling
# - pydantic: For configuration validation
# - python-dotenv: For .env file support

WORKDIR /workspace/rounds

# If requirements.txt exists, copy and install it
# For now, install expected core dependencies that the project will need
# These can be updated when requirements.txt is created
RUN pip install --no-cache-dir \
    httpx \
    pydantic \
    python-dotenv

# ============================================================================
# Stage 4: Switch to Runtime User
# ============================================================================
USER orchestrator

# ============================================================================
# Stage 5: Verification (MANDATORY)
# ============================================================================
# Verify all critical CLIs are present (from base image)
RUN claude --version && \
    git --version && \
    gh --version

# Verify Python and installed packages
RUN python3 --version && \
    pip --version && \
    python3 -c "import httpx; import pydantic; import dotenv"

# ============================================================================
# Default command
# ============================================================================
CMD ["/bin/bash"]
