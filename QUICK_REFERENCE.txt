================================================================================
ROUNDS TYPE DESIGN ANALYSIS - QUICK REFERENCE
================================================================================

OVERALL QUALITY: 7.5/10

CRITICAL ISSUES (Fix First):
  1. Diagnosis has NO validation (/workspace/rounds/core/models.py:80-90)
     - cost_usd could be negative
     - evidence could be empty
     - Effort: 15 lines, 15 minutes

  2. Enum parsing SCATTERED across adapters (3 locations)
     - SQLite adapter line 415, 380
     - Claude Code adapter line 266
     - Effort: 30 lines, 30 minutes

  3. Signature state mutations UNVALIDATED (/workspace/rounds/core/investigator.py:89)
     - Direct mutation: signature.status = SignatureStatus.NEW
     - No transition validation
     - Effort: 70 lines, 1 hour

MEDIUM ISSUES:
  4. Port interfaces use generic Exception
  5. ErrorEvent missing field validation
  6. State transition rules distributed

================================================================================
FILES TO MODIFY
================================================================================

PRIMARY CHANGES:
  /workspace/rounds/core/models.py
    - Add Diagnosis.__post_init__() validation
    - Add ModelParsers class
    - Add SignatureStatusTransition
    - Add Signature helper methods
    - Add ErrorEvent validation

SECONDARY CHANGES:
  /workspace/rounds/adapters/store/sqlite.py
    - Use ModelParsers.parse_confidence() (line 415)
    - Use ModelParsers.parse_status() (line 380)

  /workspace/rounds/adapters/diagnosis/claude_code.py
    - Use ModelParsers.parse_confidence() (line 266)

  /workspace/rounds/core/investigator.py
    - Use signature.set_status() (line 89)

  /workspace/rounds/core/triage.py
    - Use signature.is_terminal() helper

  /workspace/rounds/core/ports.py
    - Add specific exception types

TEST FILES:
  /workspace/rounds/tests/core/test_models.py
    - Add validation tests
    - Add state transition tests
    - Add enum parsing tests

================================================================================
IMPLEMENTATION ROADMAP
================================================================================

PHASE 1 (CRITICAL): 2 hours
  [ ] Add Diagnosis.__post_init__() validation
  [ ] Create ModelParsers class
  [ ] Add Signature state helpers
  GAIN: +0.5 points (7.5 → 8.0)

PHASE 2 (HIGH): 1 hour
  [ ] Define specific exception types
  [ ] Add ErrorEvent validation
  GAIN: +0.3 points (8.0 → 8.3)

PHASE 3 (MEDIUM): 1 hour
  [ ] Create SignatureStatusTransition
  GAIN: +0.1 points (8.3 → 8.4)

PHASE 4 (POLISH): 1 hour
  [ ] Add type aliases
  [ ] Additional helpers
  GAIN: +0.1 points (8.4 → 8.5)

TOTAL: ~5 hours | ~300 lines of code | 0 breaking changes

================================================================================
KEY CODE SNIPPETS
================================================================================

DIAGNOSIS VALIDATION (15 lines):
  def __post_init__(self) -> None:
      if not self.root_cause or not self.root_cause.strip():
          raise ValueError("root_cause cannot be empty")
      if not self.evidence:
          raise ValueError("evidence cannot be empty")
      if self.cost_usd < 0:
          raise ValueError("cost_usd must be non-negative...")

CENTRALIZED ENUM PARSING (30 lines):
  class ModelParsers:
      @staticmethod
      def parse_confidence(value: str) -> Confidence:
          try:
              return Confidence(value.lower())
          except ValueError:
              raise ValueError(f"Invalid confidence '{value}'...") from None

STATE VALIDATION (40 lines):
  class SignatureStatusTransition:
      VALID_TRANSITIONS = {
          SignatureStatus.NEW: {SignatureStatus.INVESTIGATING, SignatureStatus.MUTED},
          SignatureStatus.INVESTIGATING: {SignatureStatus.DIAGNOSED, SignatureStatus.NEW},
          # ... more transitions
      }
      @staticmethod
      def validate_or_raise(from_status, to_status) -> None:
          if not is_valid(from_status, to_status):
              raise ValueError(f"Invalid transition: {from_status} -> {to_status}")

STATE HELPER METHODS (30 lines):
  class Signature:
      def set_status(self, new_status: SignatureStatus) -> None:
          SignatureStatusTransition.validate_or_raise(self.status, new_status)
          self.status = new_status

      def is_terminal(self) -> bool:
          return self.status in {SignatureStatus.RESOLVED, SignatureStatus.MUTED}

      def can_investigate(self) -> bool:
          return self.status in {SignatureStatus.NEW, SignatureStatus.INVESTIGATING}

================================================================================
BEFORE & AFTER
================================================================================

BEFORE (Current):
  diagnosis = Diagnosis(root_cause="", evidence=(), cost_usd=-5.0, ...)
  # ✗ Invalid! No error caught

  signature.status = SignatureStatus.MUTED
  signature.status = SignatureStatus.INVESTIGATING  # ✗ Invalid! No error

  confidence = Confidence(response["confidence"])  # ✗ Scattered, duplicated
  confidence = Confidence(confidence_str.lower())   # ✗ Different pattern

AFTER (Improved):
  diagnosis = Diagnosis(root_cause="", evidence=(), cost_usd=-5.0, ...)
  # ✓ ValueError raised immediately!

  signature.status = SignatureStatus.MUTED
  signature.set_status(SignatureStatus.INVESTIGATING)  # ✓ ValueError raised!

  confidence = ModelParsers.parse_confidence(value)  # ✓ Centralized!

================================================================================
DOCUMENT GUIDE
================================================================================

Start here:
  → QUICK_REFERENCE.txt (this file)
  → README_TYPE_DESIGN_ANALYSIS.md (overview)
  → ANALYSIS_OVERVIEW.md (5-10 minute summary)

Then pick:
  → TYPE_DESIGN_IMPROVEMENTS.md (implementation guide with code)
  → TYPE_DESIGN_ANALYSIS.md (detailed analysis)
  → TYPE_DESIGN_VISUAL_GUIDE.md (diagrams and matrices)
  → TYPE_DESIGN_SUMMARY.md (executive summary)

All files in: /workspace/

================================================================================
SUCCESS CRITERIA
================================================================================

After Phase 1:
  ✓ Diagnosis validates cost and evidence
  ✓ Enum parsing centralized
  ✓ State transitions validated
  Quality: 8.0/10 (from 7.5/10)

After All Phases:
  ✓ All invariants enforced at construction
  ✓ No code duplication
  ✓ Specific exception types
  ✓ Comprehensive test coverage
  Quality: 8.5/10

================================================================================
EFFORT SUMMARY
================================================================================

Implementation Effort:
  Phase 1: 2 hours
  Phase 2: 1 hour
  Phase 3: 1 hour
  Phase 4: 1 hour
  TOTAL: ~5 hours

Code Changes:
  New code: ~150 lines
  Modified code: ~20 lines
  Test code: ~100 lines
  TOTAL: ~300 lines

Risk Assessment:
  Breaking changes: 0
  New public APIs: 0 (only helpers)
  Test coverage impact: Positive
  Implementation risk: Low

================================================================================
IMMEDIATE NEXT STEPS
================================================================================

1. Share ANALYSIS_OVERVIEW.md with team (5 min)
2. Review TYPE_DESIGN_IMPROVEMENTS.md (15 min)
3. Schedule 30-minute architecture review
4. Create Jira tickets for Phase 1
5. Assign to developers
6. Implement over 2-3 days
7. Review, test, merge (one at a time)
8. Celebrate improved type quality!

================================================================================
