================================================================================
ERROR HANDLING AUDIT - QUICK REFERENCE
================================================================================

PULL REQUEST: feature/issue-1-sketch-out-the-project-architecture
ANALYSIS DATE: 2026-02-12
TOTAL ISSUES: 21 (7 Critical, 8 Important, 6 Suggestions)

================================================================================
CRITICAL ISSUES - MUST FIX IMMEDIATELY
================================================================================

1. UNDEFINED VARIABLE - RUNTIME CRASH
   File: rounds/adapters/telemetry/jaeger.py:423
   Issue: Variable `spans_by_id` is used but never defined
   Impact: Crashes when collecting error spans from traces
   Fix: Define `spans_by_id = {sid: span_dicts[sid]["data"] for sid in span_dicts}`

2. SILENT TIMESTAMP FAILURE - DATA LOSS
   File: rounds/adapters/telemetry/grafana_stack.py:191-195
   Issue: Timestamp parsing errors silently fall back to "now"
   Impact: Error events show wrong timestamps, correlations fail
   Fix: Log warning when timestamp parsing fails

3. SILENT JSON PARSING - DATA LOSS
   File: rounds/adapters/telemetry/jaeger.py:199-204
   Issue: Error message JSON parsing errors silently ignored
   Impact: Error messages may be corrupted without user knowledge
   Fix: Log debug message when JSON parsing fails

4. BROAD EXCEPTION CATCHING - ERROR MASKING
   File: rounds/adapters/webhook/http_server.py:95-100
   Issue: Catches all exceptions including system errors
   Impact: Hard to debug actual failures, poor user messages
   Fix: Catch specific exception types (TimeoutError, etc.)

5. UNVALIDATED ENUM CONVERSION - USER ERROR
   File: rounds/adapters/webhook/receiver.py:287
   Issue: SignatureStatus(status.lower()) can raise ValueError
   Impact: Users get 500 error instead of "invalid status" message
   Fix: Try-catch the enum conversion, provide list of valid values

6. SILENT INVESTIGATION FAILURES - MISSING VISIBILITY
   File: rounds/core/poll_service.py:144-154
   Issue: Investigation failures are logged but not tracked
   Impact: Signatures appear stuck in investigation with no indication of failure
   Fix: Return errors alongside diagnoses so caller knows what failed

7. INCONSISTENT TELEMETRY ERROR HANDLING
   File: rounds/adapters/telemetry/signoz.py:125-130
   Issue: Broad Exception catch lumps all errors together
   Impact: Can't distinguish network errors from programming errors
   Fix: Catch specific error types (HTTPError, JSONDecodeError, etc.)

================================================================================
IMPORTANT ISSUES - FIX SOON
================================================================================

8. MISSING ERROR CONTEXT - POOR DEBUGGING
   Files: rounds/adapters/webhook/receiver.py (multiple)
   Issue: Error logs missing `exc_info=True`, no extra context
   Impact: Stack traces lost, can't debug failures
   Fix: Add `exc_info=True` and relevant context dict

9. NO ERROR IDS FOR SENTRY - POOR MONITORING
   Files: All adapter error handlers
   Issue: No error IDs from errorIds.ts for Sentry tracking
   Impact: Can't group related errors, can't set up alerts
   Fix: Add error_id to extra context in logger calls

10. RAW ERROR MESSAGES TO USERS - POOR UX
    Files: rounds/adapters/webhook/receiver.py (all handlers)
    Issue: Returns `str(e)` instead of user-friendly messages
    Impact: Users see Python internals, don't know what went wrong
    Fix: Catch specific exceptions, return meaningful messages

11. NO TIMEOUT HANDLING IN DATABASE
    File: rounds/adapters/store/sqlite.py
    Issue: Database operations can hang indefinitely
    Impact: Poll cycles hang, investigations never finish
    Fix: Add asyncio.timeout() to connection access

12. NO RESPONSE STRUCTURE VALIDATION
    File: rounds/adapters/telemetry/signoz.py:108-122
    Issue: Assumes response.json() has specific structure
    Impact: Can parse incorrect data if API changes
    Fix: Validate structure before accessing fields

13. SILENT BATCH FAILURES - INCOMPLETE RESULTS
    Files: grafana_stack.py:391-411, jaeger.py:455-475
    Issue: get_traces() silently skips failed traces
    Impact: Diagnostics based on incomplete trace data
    Fix: Document which traces failed in return or log summary

================================================================================
SUGGESTIONS - IMPROVEMENTS TO MAKE CODE ROBUST
================================================================================

14. Inconsistent error logging in diagnosis adapter
15. Missing connection string validation in SQLite
16. Missing logging for successful async operations
17. Unclear error messages (raw exceptions vs. specific types)
18. Missing documentation on error propagation strategy
19. Inconsistent try-catch patterns across adapters

================================================================================
RISK ASSESSMENT BY COMPONENT
================================================================================

HIGHEST RISK:
  - Webhook HTTP server (crashes, poor error messages)
  - Telemetry adapters (data corruption, silent failures)
  - Investigation cycle (lost failure visibility)

MEDIUM RISK:
  - Signature store (timestamp issues, no timeouts)
  - Notification adapters (missing error context)
  - Diagnosis adapter (unclear error messages)

LOWEST RISK:
  - Management service (good error handling overall)
  - Poll service (catches errors, logs them)

================================================================================
FIXING STRATEGY
================================================================================

PHASE 1 - BLOCKING BUGS (Today):
  1. Fix undefined spans_by_id variable
  2. Add validation to SignatureStatus conversion
  3. Add specific exception catching to HTTP handler

PHASE 2 - DATA LOSS (This Week):
  1. Log silent timestamp failures
  2. Log silent JSON parsing failures
  3. Track investigation failures

PHASE 3 - DEBUGGABILITY (This Sprint):
  1. Add error context to webhook handlers
  2. Add error ID tracking for Sentry
  3. User-friendly error messages

PHASE 4 - ROBUSTNESS (Next Sprint):
  1. Add timeout handling to database
  2. Validate HTTP response structures
  3. Document batch failure behavior

================================================================================
KEY METRICS
================================================================================

Total Issues Found: 21
  - Critical (Must Fix): 7
  - Important (High Priority): 8
  - Suggestions (Nice to Have): 6

Files with Issues: 10
  - Highest Impact: jaeger.py (2 critical), grafana_stack.py (2), receiver.py (5 important)
  - Most Common: Missing error context, silent failures, broad exception catching

Lines Affected: ~15 total locations
Estimated Fix Time: 2-3 hours for all critical + important issues

================================================================================
